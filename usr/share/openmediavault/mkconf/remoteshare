#!/bin/bash
#
# Copyright (C) 2013-2014 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

CRED_FILE="/root/.smbcredentials-"
OMV_REMOTESHARE_SECTION=${OMV_REMOTESHARE_SECTION:-"omv-remoteshare"}
OMV_DAVFS2_CONFIG=${OMV_DAVFS2_CONFIG:-"/etc/davfs2/davfs2.conf"}
OMV_DAVFS2_SECRETS=${OMV_DAVFS2_SECRETS:-"/etc/davfs2/secrets"}
OMV_RC_LOCAL=${OMV_RC_LOCAL:-"/etc/rc.local"}

count=$(omv_config_get_count "//services/remoteshare/smbshares/smbshare");

# remote samba share entries
index=1;
while [ ${index} -le ${count} ]; do
    credfile=$(omv_config_get "//services/remoteshare/smbshares/smbshare[position()=${index}]/usefile")
    sfref=$(omv_config_get "//services/remoteshare/smbshares/smbshare[position()=${index}]/sharedfolderref")
    username=$(omv_config_get "//services/remoteshare/smbshares/smbshare[position()=${index}]/username")
    password=$(omv_config_get "//services/remoteshare/smbshares/smbshare[position()=${index}]/password")
    
    if [ "${credfile}" != "0" ]; then
        echo "username=${username}" > ${CRED_FILE}${sfref}
        echo "password=${password}" >> ${CRED_FILE}${sfref}
    fi
    
    index=$(( ${index} + 1 ))
done;

# add credentials to davfs2 secrets file
secent=$(
    echo -n "# >>> [${OMV_REMOTESHARE_SECTION}]\n";
    count=$(omv_config_get_count "//services/remoteshare/webdavshares/webdavshare");

    # remote webdav share entries
    index=1;
    while [ ${index} -le ${count} ]; do
        username=$(omv_config_get "//services/remoteshare/webdavshares/webdavshare[position()=${index}]/username")
        password=$(omv_config_get "//services/remoteshare/webdavshares/webdavshare[position()=${index}]/password")
        sfref=$(omv_config_get "//services/remoteshare/webdavshares/webdavshare[position()=${index}]/sharedfolderref")
        sfpath=$(omv_get_sharedfolder_path "${sfref}")
    
        echo -n "${sfpath} ${username} ${password}\n"
    
        index=$(( ${index} + 1 ))
    done;
    echo -n "# <<< [${OMV_REMOTESHARE_SECTION}]"
)

# Append credentials to secrets file if not still present or replace existing entries.
if ! grep -E "^# >>> \[${OMV_REMOTESHARE_SECTION}\]\s*$" ${OMV_DAVFS2_SECRETS} >/dev/null; then
    echo -e "${secent}" >> ${OMV_DAVFS2_SECRETS}
else
    sed -i "/# >>> \[${OMV_REMOTESHARE_SECTION}\]/,/# <<< \[${OMV_REMOTESHARE_SECTION}\]/ c ${secent}" ${OMV_DAVFS2_SECRETS}
fi

rclocent=$(
    echo -n "# >>> [${OMV_REMOTESHARE_SECTION}]\n";
    echo -n "mount -a -O _netdev\n";
    echo -n "# <<< [${OMV_REMOTESHARE_SECTION}]\n"
)
    
# Append mount command to rc.local otherwise the shares will not be remounted on reboot (hint: _netdev)
if ! grep -E "^# >>> \[${OMV_REMOTESHARE_SECTION}\]\s*$" ${OMV_RC_LOCAL} >/dev/null; then
    sed -i -e "\$i ${rclocent}" ${OMV_RC_LOCAL} # $i means 'insert before last line (exit 0)'
else
    sed -i "/# >>> \[${OMV_REMOTESHARE_SECTION}\]/,/# <<< \[${OMV_REMOTESHARE_SECTION}\]/ c ${rclocent}" ${OMV_RC_LOCAL}
fi

omv-mkconf fstab
mount -a
